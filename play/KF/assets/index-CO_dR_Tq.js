(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();var d=(r=>(r[r.START_TURN=0]="START_TURN",r[r.ROLLED=1]="ROLLED",r[r.HUMAN_REROLL=2]="HUMAN_REROLL",r[r.AI_THINKING=3]="AI_THINKING",r[r.AI_DECIDING=4]="AI_DECIDING",r[r.AI_REROLL=5]="AI_REROLL",r[r.GAME_OVER=6]="GAME_OVER",r))(d||{});const P=r=>{let e=0;const t={1:0,2:0,3:0,4:0,5:0,6:0};for(const s of r)t[s]++;if(r.length===0)return{score:0,scoringDice:[],isInvalidSelection:!1};if(r.length===6&&Object.values(t).every(n=>n===1))return{score:5e3,scoringDice:r,isInvalidSelection:!1};let i=r.length;for(let s=1;s<=6;s++){const n=s,o=t[n];if(o>=3){const l=n===1?1e3:n*100;e+=l*(o-2),i-=o,t[n]=0}}return t[1]>0&&(e+=t[1]*100,i-=t[1]),t[5]>0&&(e+=t[5]*50,i-=t[5]),i>0?{score:0,scoringDice:[],isInvalidSelection:!0}:{score:e,scoringDice:r,isInvalidSelection:!1}},F=r=>{const e=r.map(i=>i.value),t={1:0,2:0,3:0,4:0,5:0,6:0};for(const i of e)t[i]++;if(t[1]>0||t[5]>0)return!0;for(const i in t)if(t[i]>=3)return!0;return!!(r.length===6&&Object.values(t).every(i=>i===1))},M=r=>{const e=[];let t=r.filter(s=>!s.isHeld);if(t.length===6){const s=t.map(n=>n.value);if(new Set(s).size===6)return e.push(t.map(n=>n.id)),e}const i={1:[],2:[],3:[],4:[],5:[],6:[]};t.forEach(s=>i[s.value].push(s));for(let s=1;s<=6;s++){const n=s,o=i[n];o.length>=3&&(e.push(o.map(l=>l.id)),t=t.filter(l=>l.value!==n))}return t.forEach(s=>{(s.value===1||s.value===5)&&e.push([s.id])}),e},R=5e3,H=()=>{const r=Array(6).fill(null).map((e,t)=>({id:t,value:Math.floor(Math.random()*6)+1,isHeld:!1,isScoring:!1}));return{players:{human:{score:0},ai:{score:0}},currentPlayer:"human",phase:d.START_TURN,dice:r,turnScore:0,roundScore:0,isRolling:!1}};class z{constructor(){this.state=H()}restart(){this.state=H()}startRoll(e){this.state.isRolling=!0,this.state.dice=e}endRoll(e){const t=this.state.dice.map(n=>n.isHeld?n:{...n,value:e[n.id],isScoring:!1});this.state.dice=t,this.state.isRolling=!1;const i=t.filter(n=>!n.isHeld),s=!F(i);return this.state.phase=d.ROLLED,{isFarkle:s}}toggleScoringGroup(e){if(this.state.phase!==d.ROLLED||this.state.currentPlayer!=="human")return;const t=e[0],i=this.state.dice.find(c=>c.id===t);if(!i||i.isHeld)return;const s=i.isScoring,n=this.state.dice.map(c=>e.includes(c.id)?{...c,isScoring:!s}:c),o=n.filter(c=>c.isScoring&&!c.isHeld).map(c=>c.value),{score:l}=P(o);this.state.dice=n,this.state.roundScore=l}commitSelection(){this.state.turnScore+=this.state.roundScore;const e=this.state.dice.map(i=>i.isScoring?{...i,isHeld:!0,isScoring:!1}:i),t=e.every(i=>i.isHeld);return this.state.dice=t?e.map(i=>({...i,isHeld:!1})):e,this.state.roundScore=0,this.state.phase=this.state.currentPlayer==="human"?d.HUMAN_REROLL:d.AI_REROLL,{isHotDice:t}}bankScore(){const e=this.state.turnScore+this.state.roundScore,t=this.state.players[this.state.currentPlayer].score+e;return this.state.players[this.state.currentPlayer].score=t,t>=R?(this.state.phase=d.GAME_OVER,{winner:this.state.currentPlayer}):(this.nextTurn(),{winner:null})}farkle(){this.nextTurn()}nextTurn(){this.state.turnScore=0,this.state.roundScore=0,this.state.dice=this.state.dice.map(e=>({...e,isHeld:!1,isScoring:!1})),this.state.phase=d.START_TURN,this.state.currentPlayer=this.state.currentPlayer==="human"?"ai":"human"}aiThink(){this.state.currentPlayer==="ai"&&(this.state.phase=d.AI_THINKING)}aiSelectDice(e){if(this.state.currentPlayer!=="ai")return;const t=this.state.dice.map(n=>e.includes(n.id)?{...n,isScoring:!0}:n),i=t.filter(n=>n.isScoring&&!n.isHeld).map(n=>n.value),{score:s}=P(i);this.state.dice=t,this.state.roundScore=s,this.state.phase=d.AI_DECIDING}}class O{constructor(e){this.app=e,this.stage=e.stage,this.createMainMenu(),this.createGameUI(),this.createPauseMenu(),this.createHowToPlay(),this.createFarkleMessage(),this.hideAll()}createMainMenu(){this.mainMenuContainer=new PIXI.Container,this.mainMenuContainer.zIndex=10,this.stage.addChild(this.mainMenuContainer);const e=new PIXI.Text("Kingdom Farkle",{fontFamily:"MedievalSharp",fontSize:92,fill:"#fde08d",stroke:"#000",strokeThickness:6,align:"center",dropShadow:!0,dropShadowColor:"#000000",dropShadowBlur:8,dropShadowDistance:6});e.anchor.set(.5),e.position.set(this.app.screen.width/2,this.app.screen.height/2-100),e.name="title",this.mainMenuContainer.addChild(e);const t=new PIXI.Text("The Royal Dice Game of Chance and Skill",{fontFamily:"IM Fell English SC",fontSize:24,fill:"#fcd34d",align:"center"});t.anchor.set(.5),t.position.set(this.app.screen.width/2,this.app.screen.height/2-30),t.name="subtitle",this.mainMenuContainer.addChild(t),this.playButton=this.createButton("Play Game",this.app.screen.width/2,this.app.screen.height/2+80,1467700),this.mainMenuContainer.addChild(this.playButton)}createGameUI(){this.gameContainer=new PIXI.Container,this.gameContainer.zIndex=1,this.stage.addChild(this.gameContainer),this.createScoreboard(),this.rollButton=this.createButton("Roll",this.app.screen.width/2-100,this.app.screen.height-30,1920728),this.bankButton=this.createButton("Bank Points",this.app.screen.width/2+100,this.app.screen.height-30,1467700),this.gameContainer.addChild(this.rollButton),this.gameContainer.addChild(this.bankButton)}createScoreboard(){const e=new PIXI.Container;e.name="scoreContainer",this.gameContainer.addChild(e);const t=new PIXI.Graphics,i=-15,s=-15,n=20;t.beginFill(0,.4),t.endFill(),e.addChild(t);const o=n-i,l=n-s;e.position.set(l,o);const c={fontFamily:"IM Fell English SC",fontSize:22,fill:"#fde08d"},f={fontFamily:"IM Fell English SC",fontSize:24,fontWeight:"bold"},m=0,S=125,x=250,h=new PIXI.Text("You",c);h.position.set(m,0);const a=new PIXI.Text("Goal",{...c,align:"center"});a.anchor.x=.5,a.position.set(S,0);const u=new PIXI.Text("Opponent",{...c,align:"right"});u.anchor.x=1,u.position.set(x,0),e.addChild(h,a,u),this.youScoreText=new PIXI.Text("0",{...f,fill:"#60a5fa"}),this.youScoreText.position.set(m,30),this.goalScoreText=new PIXI.Text(R,{...f,fill:"#fde08d"}),this.goalScoreText.anchor.x=.5,this.goalScoreText.position.set(S,30),this.opponentScoreText=new PIXI.Text("0",{...f,fill:"#f87171"}),this.opponentScoreText.anchor.x=1,this.opponentScoreText.position.set(x,30),e.addChild(this.youScoreText,this.goalScoreText,this.opponentScoreText);const g=new PIXI.Graphics;g.lineStyle(1,16638093,.5).moveTo(0,65).lineTo(250,65),e.addChild(g);const y={fontFamily:"IM Fell English SC",fontSize:18,fill:"#fde08d"},p={...y,fill:"#4ade80"},T=new PIXI.Text("Round",{...y,align:"center"});T.anchor.x=.5,T.position.set(S,75);const w=new PIXI.Text("Selected",{...y,align:"center"});w.anchor.x=.5,w.position.set(S,95),e.addChild(T,w),this.youRoundScoreText=new PIXI.Text("0",{...p,align:"left"}),this.youRoundScoreText.position.set(m,75),this.youSelectedScoreText=new PIXI.Text("0",{...p,align:"left"}),this.youSelectedScoreText.position.set(m,95),e.addChild(this.youRoundScoreText,this.youSelectedScoreText),this.opponentRoundScoreText=new PIXI.Text("0",{...p,align:"right"}),this.opponentRoundScoreText.anchor.x=1,this.opponentRoundScoreText.position.set(x,75),this.opponentSelectedScoreText=new PIXI.Text("0",{...p,align:"right"}),this.opponentSelectedScoreText.anchor.x=1,this.opponentSelectedScoreText.position.set(x,95),e.addChild(this.opponentRoundScoreText,this.opponentSelectedScoreText)}createPauseMenu(){this.pauseContainer=new PIXI.Container,this.pauseContainer.zIndex=10;const e=new PIXI.Graphics().beginFill(0,.7).drawRect(0,0,this.app.screen.width,this.app.screen.height).endFill();e.name="overlay",this.pauseContainer.addChild(e);const t=new PIXI.Text("Paused",{fontFamily:"MedievalSharp",fontSize:80,fill:"#fde08d"});t.anchor.set(.5),t.position.set(this.app.screen.width/2,this.app.screen.height/2-150),t.name="pauseText",this.pauseContainer.addChild(t),this.resumeButton=this.createButton("Return to Game",this.app.screen.width/2,this.app.screen.height/2-20,1467700),this.howToPlayButton=this.createButton("How to Play",this.app.screen.width/2,this.app.screen.height/2+60,1920728),this.quitButton=this.createButton("Quit to Menu",this.app.screen.width/2,this.app.screen.height/2+140,10033947),this.pauseContainer.addChild(this.resumeButton,this.howToPlayButton,this.quitButton),this.stage.addChild(this.pauseContainer)}createHowToPlay(){this.howToPlayContainer=new PIXI.Container,this.howToPlayContainer.zIndex=20;const e=new PIXI.Graphics().beginFill(0,.7).drawRect(0,0,this.app.screen.width,this.app.screen.height).endFill();e.name="overlay",this.howToPlayContainer.addChild(e);const t=new PIXI.Graphics().lineStyle(2,16638093,.8).beginFill(1976635,.9).drawRoundedRect(0,0,800,600,10).endFill();t.position.set(this.app.screen.width/2-400,this.app.screen.height/2-300),t.name="panel",this.howToPlayContainer.addChild(t);const i=new PIXI.Text("How to Play",{fontFamily:"MedievalSharp",fontSize:60,fill:"#fde08d"});i.anchor.set(.5),i.position.set(this.app.screen.width/2,this.app.screen.height/2-220),i.name="title",this.howToPlayContainer.addChild(i);const s=`• Roll dice to start your turn.
• Set aside one or more scoring dice after each roll.
• You must score at least one die to continue.
• You can then Bank your points or Roll remaining dice.
• If a roll has no scoring dice, you Farkle and lose all points for the turn.
• If all 6 dice are scored ('Hot Dice'), you may roll them all again.`,n=`Scoring Combos
1 .................................................. 100
5 .................................................... 50
3 x 1 .......................................... 1000
3 x 2 ............................................ 200
3 x 3 ............................................ 300
3 x 4 ............................................ 400
3 x 5 ............................................ 500
3 x 6 ............................................ 600
Straight (1-6) ....................... 1500
* 4+ of a kind doubles previous\n combo score`,o={fontFamily:"IM Fell English SC",fontSize:24,fill:"#fde68a",wordWrap:!0,wordWrapWidth:350,lineHeight:30},l=new PIXI.Text(s,o);l.position.set(this.app.screen.width/2-350,this.app.screen.height/2-150),l.name="rulesText",this.howToPlayContainer.addChild(l);const c=new PIXI.Text(n,{...o,wordWrap:!1});c.position.set(this.app.screen.width/2+50,this.app.screen.height/2-150),c.name="scoringText",this.howToPlayContainer.addChild(c),this.backButton=this.createButton("Back",this.app.screen.width/2,this.app.screen.height/2+220,10033947),this.howToPlayContainer.addChild(this.backButton),this.stage.addChild(this.howToPlayContainer)}createFarkleMessage(){this.farkleText=new PIXI.Text("FARKLE!",{fontFamily:"MedievalSharp",fontSize:120,fill:"#dc2626",stroke:"#000",strokeThickness:8,align:"center",dropShadow:!0,dropShadowColor:"#000000",dropShadowBlur:10,dropShadowDistance:8}),this.farkleText.anchor.set(.5),this.farkleText.position.set(this.app.screen.width/2,this.app.screen.height/2),this.farkleText.visible=!1,this.farkleText.zIndex=5,this.stage.addChild(this.farkleText)}createButton(e,t,i,s){const n=new PIXI.Container;n.interactive=!0,n.cursor="pointer";const o=new PIXI.Text(e,{fontFamily:"IM Fell English SC",fontSize:24,fill:"#ffffff",fontWeight:"bold"});o.anchor.set(.5);const l=new PIXI.Graphics;return l.beginFill(s,1),l.drawRoundedRect(-o.width/2-20,-o.height/2-10,o.width+40,o.height+20,8),l.endFill(),l.name="background",n.addChild(l),n.addChild(o),n.position.set(t,i),n.on("pointerover",()=>l.tint=13421772),n.on("pointerout",()=>l.tint=16777215),n}hideAll(){this.mainMenuContainer.visible=!1,this.gameContainer.visible=!1,this.pauseContainer.visible=!1,this.howToPlayContainer.visible=!1,this.winnerContainer&&(this.winnerContainer.visible=!1),this.farkleText&&(this.farkleText.visible=!1)}showMainMenu(){this.hideAll(),this.mainMenuContainer.visible=!0}showGame(){this.hideAll(),this.gameContainer.visible=!0}showPauseMenu(){this.pauseContainer.visible=!0}hidePauseMenu(){this.pauseContainer.visible=!1}showHowToPlay(){this.howToPlayContainer.visible=!0}hideHowToPlay(){this.howToPlayContainer.visible=!1}showFarkleMessage(){this.farkleText.visible=!0}hideFarkleMessage(){this.farkleText.visible=!1}update(e){this.youScoreText.text=e.players.human.score,this.opponentScoreText.text=e.players.ai.score;const t=e.turnScore+e.roundScore;e.currentPlayer==="human"?(this.youRoundScoreText.text=t,this.youSelectedScoreText.text=e.roundScore,this.opponentRoundScoreText.text="0",this.opponentSelectedScoreText.text="0"):(this.opponentRoundScoreText.text=t,this.opponentSelectedScoreText.text=e.roundScore,this.youRoundScoreText.text="0",this.youSelectedScoreText.text="0");const i=(e.phase===d.START_TURN||e.phase===d.ROLLED&&e.roundScore>0)&&e.currentPlayer==="human"&&!e.isRolling,s=e.roundScore>0&&e.phase===d.ROLLED&&e.currentPlayer==="human";this.updateButton(this.rollButton,i,e.isRolling?"Rolling...":"Roll"),this.updateButton(this.bankButton,s)}updateButton(e,t,i){e.interactive=t,e.alpha=t?1:.5,i&&e.children[1]&&(e.children[1].text=i)}showWinner(e){this.winnerContainer&&this.stage.removeChild(this.winnerContainer),this.winnerContainer=new PIXI.Container,this.winnerContainer.zIndex=10;const t=new PIXI.Graphics().beginFill(0,.8).drawRect(0,0,this.app.screen.width,this.app.screen.height).endFill();t.name="overlay",this.winnerContainer.addChild(t);const i=e==="human"?"You are Victorious!":"The AI has Defeated You!",s=new PIXI.Text(i,{fontFamily:"MedievalSharp",fontSize:60,fill:"#fcd34d",align:"center"});s.anchor.set(.5),s.position.set(this.app.screen.width/2,this.app.screen.height/2-100),s.name="winnerText",this.winnerContainer.addChild(s);const n=this.createButton("Play Again",this.app.screen.width/2,this.app.screen.height/2+20,13273604);n.name="playAgainButton",this.winnerContainer.addChild(n);const o=this.createButton("Quit to Menu",this.app.screen.width/2,this.app.screen.height/2+90,10033947);return o.name="quitButton",this.winnerContainer.addChild(o),this.stage.addChild(this.winnerContainer),{playAgainButton:n,quitButton:o}}hideWinner(){this.winnerContainer&&(this.winnerContainer.visible=!1)}resize(e,t){if(this.mainMenuContainer){const i=this.mainMenuContainer.getChildByName("title");i&&i.position.set(e/2,t/2-100);const s=this.mainMenuContainer.getChildByName("subtitle");s&&s.position.set(e/2,t/2-30),this.playButton&&this.playButton.position.set(e/2,t/2+80)}if(this.gameContainer){this.rollButton&&this.rollButton.position.set(e/2-100,t-60),this.bankButton&&this.bankButton.position.set(e/2+100,t-60);const i=this.gameContainer.getChildByName("scoreContainer");i&&i.position.set(35,35)}if(this.pauseContainer){const i=this.pauseContainer.getChildByName("overlay");i&&i.clear().beginFill(0,.7).drawRect(0,0,e,t).endFill();const s=this.pauseContainer.getChildByName("pauseText");s&&s.position.set(e/2,t/2-150),this.resumeButton&&this.resumeButton.position.set(e/2,t/2-20),this.howToPlayButton&&this.howToPlayButton.position.set(e/2,t/2+60),this.quitButton&&this.quitButton.position.set(e/2,t/2+140)}if(this.howToPlayContainer){const i=this.howToPlayContainer.getChildByName("overlay");i&&i.clear().beginFill(0,.7).drawRect(0,0,e,t).endFill();const s=this.howToPlayContainer.getChildByName("panel");s&&s.position.set(e/2-400,t/2-300);const n=this.howToPlayContainer.getChildByName("title");n&&n.position.set(e/2,t/2-220);const o=this.howToPlayContainer.getChildByName("rulesText");o&&o.position.set(e/2-350,t/2-150);const l=this.howToPlayContainer.getChildByName("scoringText");l&&l.position.set(e/2+50,t/2-150),this.backButton&&this.backButton.position.set(e/2,t/2+220)}if(this.winnerContainer){const i=this.winnerContainer.getChildByName("overlay");i&&i.clear().beginFill(0,.8).drawRect(0,0,e,t).endFill();const s=this.winnerContainer.getChildByName("winnerText");s&&s.position.set(e/2,t/2-100);const n=this.winnerContainer.getChildByName("playAgainButton");n&&n.position.set(e/2,t/2+20);const o=this.winnerContainer.getChildByName("quitButton");o&&o.position.set(e/2,t/2+90)}this.farkleText&&this.farkleText.position.set(e/2,t/2)}}const N="#4a2c1a",G="#fde68a",V="#fcd34d",X="#4ade80",I=class I{constructor(e){this.stuckCounter=0,this.isHot=!1,this.data=e,I.faceTextures.length===0&&I.generateFaceTextures(),I.FACE_NORMALS||(I.FACE_NORMALS=[new THREE.Vector3(1,0,0),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1)]),this.materials=I.faceTextures.map(n=>new THREE.MeshStandardMaterial({map:n,metalness:.1,roughness:.2}));const t=new THREE.BoxGeometry(1,1,1);this.mesh=new THREE.Mesh(t,this.materials),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.mesh.userData={id:this.data.id,class:this};const i=new THREE.RingGeometry(.6,.7,32),s=new THREE.MeshBasicMaterial({color:X,side:THREE.DoubleSide,transparent:!0,opacity:.9});this.highlightCircle=new THREE.Mesh(i,s),this.highlightCircle.rotation.x=-Math.PI/2,this.highlightCircle.position.y=.01,this.highlightCircle.visible=!1,this.updateStateVisuals(),this.velocity=new THREE.Vector3,this.angularVelocity=new THREE.Vector3}static generateFaceTextures(){const i={1:[[.5,.5]],2:[[.25,.25],[.75,.75]],3:[[.25,.25],[.5,.5],[.75,.75]],4:[[.25,.25],[.75,.25],[.25,.75],[.75,.75]],5:[[.25,.25],[.75,.25],[.5,.5],[.25,.75],[.75,.75]],6:[[.25,.25],[.75,.25],[.25,.5],[.75,.5],[.25,.75],[.75,.75]]};for(let s=1;s<=6;s++){const n=document.createElement("canvas");n.width=128,n.height=128;const o=n.getContext("2d");o.fillStyle=G,o.fillRect(0,0,128,128),o.fillStyle=N,i[s].forEach(([l,c])=>{o.beginPath(),o.arc(l*128,c*128,18,0,2*Math.PI),o.fill()}),this.faceTextures.push(new THREE.CanvasTexture(n))}}updateData(e){const t=this.data.isHeld!==e.isHeld||this.data.isScoring!==e.isScoring;this.data=e,t&&this.updateStateVisuals()}updateStateVisuals(){this.data.isHeld&&(this.mesh.position.y=.2);const e=this.data.isHeld?V:16777215;this.materials.forEach(t=>{t.color.set(e)}),this.highlightCircle.visible=this.data.isScoring}setHot(e){this.isHot=e,e||this.materials.forEach(t=>{t.emissive.set(0),t.emissiveIntensity=0})}setEmissiveIntensity(e){this.materials.forEach(t=>{t.emissive.set(16737792),t.emissiveIntensity=e})}setValue(e){this.data.value=e;const i={1:{x:0,y:0,z:-Math.PI/2},2:{x:0,y:0,z:Math.PI/2},3:{x:0,y:0,z:0},4:{x:Math.PI,y:0,z:0},5:{x:Math.PI/2,y:0,z:0},6:{x:-Math.PI/2,y:0,z:0}}[e];this.mesh.rotation.set(i.x,i.y,i.z)}getUpValue(){let e=-1/0,t=1;const i=new THREE.Vector3(0,1,0);for(let s=0;s<I.FACE_NORMALS.length;s++){const l=I.FACE_NORMALS[s].clone().applyQuaternion(this.mesh.quaternion).dot(i);l>e&&(e=l,t=s+1)}return t}};I.faceTextures=[];let v=I;class _{constructor(e){this.banterTimer=null,this.isVisible=!0,this.app=e,this.stage=e.stage;const t=PIXI.Texture.from("https://breakingpointgames.com/play/images/kf/opponent1.png");this.opponentSprite=new PIXI.Sprite(t),this.opponentSprite.anchor.set(.5,0),this.opponentSprite.scale.set(.4),this.opponentSprite.visible=!1,this.opponentSprite.zIndex=2,this.speechBubble=new PIXI.Container,this.speechBubble.visible=!1,this.speechBubble.zIndex=3;const i=new PIXI.Graphics;i.name="background",this.speechBubble.addChild(i),this.speechText=new PIXI.Text("",{fontFamily:"IM Fell English SC",fontSize:24,fill:"#1e293b",wordWrap:!0,wordWrapWidth:240,align:"center"}),this.speechText.anchor.set(.5),this.speechBubble.addChild(this.speechText),this.stage.addChild(this.opponentSprite),this.stage.addChild(this.speechBubble)}showBanter(e){return new Promise(t=>{if(!this.isVisible){t();return}this.banterTimer&&clearTimeout(this.banterTimer),this.speechText.text=e,this.speechBubble.getChildByName("background").clear().beginFill(16639626,.9).lineStyle(2,4860954,.8).drawRoundedRect(-this.speechText.width/2-20,-this.speechText.height/2-15,this.speechText.width+40,this.speechText.height+30,10),this.speechBubble.visible=!0,this.banterTimer=window.setTimeout(()=>{this.speechBubble.visible=!1,this.banterTimer=null,t()},5e3)})}show(){this.isVisible=!0,this.opponentSprite.visible=!0}hide(){this.isVisible=!1,this.opponentSprite.visible=!1,this.speechBubble.visible=!1,this.banterTimer&&clearTimeout(this.banterTimer)}resize(e,t){this.opponentSprite.position.set(e/2,10),this.speechBubble.position.set(e/2,this.opponentSprite.y+this.opponentSprite.height-10)}}const B={gameStart:["Let's see if you have any skill.","Another challenger... Hmph.","Don't waste my time.","Ready to lose your coin?"],playerFarkle:["Heh. Unlucky.","That's what happens when you get greedy.","Nothing. As expected.","A wasted turn."],aiFarkle:["Cursed dice!","Hmph. A miscalculation.","Bah!","The dice are fickle today."],playerBank:["Smart move. For once.","Banking so soon? Cowardly.","A respectable score, I suppose.","Not bad... for you."],aiBank:["Points on the board. Simple.","Slow and steady.","That'll do.","My turn."],playerHotDice:["Luck is on your side... for now.","Don't get cocky.","Impressive. Let's see you do it again.","Hmph. Hot dice."],aiHotDice:["The dice bend to my will.","Perfectly played.","Now, for the real roll.","Just as I planned."],playerIsWinning:["Don't celebrate yet.","The game isn't over.","Your luck will run out.","Feeling bold, are we?"],aiIsWinning:["Victory is near.","I can taste it.","You can't catch me now.","It's almost over."],idle:["...","Hurry up.","Are you going to roll or not?"]},U=-9.8*2.5,E=.4,L=.98,q=.95,W=.1;class Y{constructor(e){this.threeDice=[],this.log=[],this.timers={},this.elapsedTime=0,this.physicsActive=!1,this.settledFrames=0,this.appPhase=0,this.isIntroRoll=!1,this.isHotDiceActive=!1,this.rollTimeout=null,this.frustumSize=16.5,this.initialWidth=800,this.initialHeight=600,this.timerCallbacks={},this.container=e,this.gsm=new z,this.initThree(),this.initPixi(),this.ui=new O(this.pixiApp),this.opponent=new _(this.pixiApp),this.setupEventListeners()}initPixi(){this.pixiApp=new PIXI.Application({width:this.initialWidth,height:this.initialHeight,backgroundAlpha:0,antialias:!0}),this.pixiApp.stage.sortableChildren=!0,this.pixiApp.view.style.position="absolute",this.pixiApp.view.style.top="0",this.pixiApp.view.style.left="0",this.pixiApp.view.style.zIndex="2",this.container.appendChild(this.pixiApp.view)}initThree(){this.threeScene=new THREE.Scene;const e=this.initialWidth/this.initialHeight;this.threeCamera=new THREE.OrthographicCamera(this.frustumSize*e/-2,this.frustumSize*e/2,this.frustumSize/2,this.frustumSize/-2,1,100),this.threeCamera.position.set(0,10,0),this.threeCamera.lookAt(0,0,0),this.threeRenderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.threeRenderer.setSize(this.initialWidth,this.initialHeight),this.threeRenderer.shadowMap.enabled=!0,this.threeRenderer.shadowMap.type=THREE.PCFSoftShadowMap,this.threeRenderer.domElement.style.position="absolute",this.threeRenderer.domElement.style.top="0",this.threeRenderer.domElement.style.left="0",this.threeRenderer.domElement.style.zIndex="1",this.container.appendChild(this.threeRenderer.domElement);const t=new THREE.HemisphereLight(16772785,526368,.8);this.threeScene.add(t),this.threeDirectionalLight=new THREE.DirectionalLight(16772785,.6),this.threeDirectionalLight.position.set(-5,10,5),this.threeDirectionalLight.castShadow=!0,this.threeDirectionalLight.shadow.mapSize.width=2048,this.threeDirectionalLight.shadow.mapSize.height=2048,this.threeDirectionalLight.shadow.camera.left=-10,this.threeDirectionalLight.shadow.camera.right=10,this.threeDirectionalLight.shadow.camera.top=10,this.threeDirectionalLight.shadow.camera.bottom=-10,this.threeScene.add(this.threeDirectionalLight);const i=this.frustumSize*e,s=this.frustumSize,n=new THREE.PlaneGeometry(i,s),l=new THREE.TextureLoader().load("https://breakingpointgames.com/play/images/kf/wooden-bg.jpeg"),c=new THREE.MeshStandardMaterial({map:l,roughness:.8,metalness:.2});this.threePlane=new THREE.Mesh(n,c),this.threePlane.rotation.x=-Math.PI/2,this.threePlane.position.y=0,this.threePlane.receiveShadow=!0,this.threeScene.add(this.threePlane),this.gsm.state.dice.forEach(f=>{const m=new v(f);m.mesh.position.set(-20,.5,0),m.mesh.visible=!1,m.highlightCircle.visible=!1,m.setValue(f.value),this.threeDice.push(m),this.threeScene.add(m.mesh),this.threeScene.add(m.highlightCircle)}),this.threeRaycaster=new THREE.Raycaster,this.pointer=new THREE.Vector2}setupEventListeners(){this.ui.playButton.on("pointerdown",()=>this.startGame()),this.ui.rollButton.on("pointerdown",()=>this.handleRoll()),this.ui.bankButton.on("pointerdown",()=>this.handleBank()),this.pixiApp.view.addEventListener("pointerdown",t=>this.onCanvasClick(t)),this.ui.resumeButton.on("pointerdown",()=>this.resumeGame()),this.ui.howToPlayButton.on("pointerdown",()=>this.showHowToPlay()),this.ui.quitButton.on("pointerdown",()=>this.quitToMenu()),this.ui.backButton.on("pointerdown",()=>this.hideHowToPlay()),window.addEventListener("keydown",t=>this.handleKeyPress(t));const e=document.getElementById("fullscreen-btn");e&&e.addEventListener("click",()=>this.toggleFullscreen()),document.addEventListener("fullscreenchange",()=>this.onFullscreenChange())}async load(){}start(){this.pixiApp.ticker.add(()=>this.update()),this.ui.showMainMenu()}update(){const e=this.pixiApp.ticker.deltaMS/1e3;if(this.elapsedTime+=e,this.threeDirectionalLight.position.x=-5+Math.sin(this.elapsedTime*.1)*.5,this.isHotDiceActive){const t=1+Math.sin(this.elapsedTime*6)*.5;this.threeDice.forEach(i=>{i.setEmissiveIntensity(t)})}this.appPhase===1&&(this.physicsActive&&this.updatePhysics(e),this.runTimers(this.pixiApp.ticker.deltaTime)),this.threeDice.forEach(t=>{t.highlightCircle.position.x=t.mesh.position.x,t.highlightCircle.position.z=t.mesh.position.z}),this.threeRenderer.render(this.threeScene,this.threeCamera)}runTimers(e){Object.keys(this.timers).forEach(t=>{if(this.timers[t]-=e,this.timers[t]<=0){const i=this.timerCallbacks[t];delete this.timers[t],delete this.timerCallbacks[t],i&&i()}})}setTimer(e,t,i){this.timers[e]=t,this.timerCallbacks[e]=i}updatePhysics(e){e>.05&&(e=.05);const t=this.threeDice.filter(h=>!h.data.isHeld);if(t.length===0&&this.physicsActive&&!this.isIntroRoll){this.endPhysicsRoll();return}const i=this.threeDice,s={x:this.threeCamera.right,z:this.threeCamera.top},n=.5,o=.7;t.forEach(h=>{h.velocity.y+=U*e,h.mesh.position.add(h.velocity.clone().multiplyScalar(e));const a=h.angularVelocity.length();if(a>0){const u=new THREE.Quaternion,g=h.angularVelocity.clone().normalize();u.setFromAxisAngle(g,a*e),h.mesh.quaternion.multiplyQuaternions(u,h.mesh.quaternion)}});const l=5,c=3.8;for(let h=0;h<l;h++)for(let a=0;a<i.length;a++){const u=i[a];u.data.isHeld||(u.mesh.position.y<n&&(u.mesh.position.y=n),Math.abs(u.mesh.position.x)>s.x-n&&(u.mesh.position.x=Math.sign(u.mesh.position.x)*(s.x-n)),u.mesh.position.z>c-n&&(u.mesh.position.z=c-n),u.mesh.position.z<-c+n&&(u.mesh.position.z=-c+n));for(let g=a+1;g<i.length;g++){const y=i[g],p=y.mesh.position.clone().sub(u.mesh.position),T=p.length();if(T<o*2){const w=o*2-T,C=p.normalize();if(u.data.isHeld&&y.data.isHeld)continue;u.data.isHeld?y.mesh.position.add(C.clone().multiplyScalar(w)):y.data.isHeld?u.mesh.position.add(C.clone().multiplyScalar(-w)):(u.mesh.position.add(C.clone().multiplyScalar(-w/2)),y.mesh.position.add(C.clone().multiplyScalar(w/2)))}}}for(let h=0;h<i.length;h++){const a=i[h];if(!a.data.isHeld){a.mesh.position.y<=n+.01&&(a.velocity.y<0&&(a.velocity.y*=-E),a.velocity.x*=L,a.velocity.z*=L,a.angularVelocity.multiplyScalar(q)),Math.abs(a.mesh.position.x)>=s.x-n&&Math.sign(a.mesh.position.x)*a.velocity.x>0&&(a.velocity.x*=-E),a.mesh.position.z>=c-n&&a.velocity.z>0&&(a.velocity.z*=-E),a.mesh.position.z<=-c+n&&a.velocity.z<0&&(a.velocity.z*=-E);for(let u=h+1;u<i.length;u++){const g=i[u],y=g.mesh.position.clone().sub(a.mesh.position);if(y.length()<o*2){const p=y.normalize();if(g.data.isHeld){const T=a.velocity.dot(p);if(T>0)continue;a.velocity.add(p.clone().multiplyScalar(-T*(1+E)))}else{if(g.velocity.clone().sub(a.velocity).dot(p)>0)continue;const C=a.velocity.dot(p),b=g.velocity.dot(p),k=(C+b-(C-b)*E)/2,D=(C+b-(b-C)*E)/2;a.velocity.add(p.clone().multiplyScalar(k-C)),g.velocity.add(p.clone().multiplyScalar(D-b))}}}}}let f=0;const m=.1,S=n+.1,x=90;for(const h of t){if(h.velocity.lengthSq()<m&&h.angularVelocity.lengthSq()>.5&&h.mesh.position.y<S?h.stuckCounter++:h.stuckCounter=0,h.stuckCounter>x){const a=h.getUpValue();h.setValue(a),h.velocity.set(0,0,0),h.angularVelocity.set(0,0,0),h.stuckCounter=0}if(h.velocity.lengthSq()<.5&&h.mesh.position.y<n+.1){const a=new THREE.Vector3(0,-1,0);let u=-1/0,g=new THREE.Vector3;for(let p=0;p<v.FACE_NORMALS.length;p++){const T=v.FACE_NORMALS[p].clone().applyQuaternion(h.mesh.quaternion),w=T.dot(a);w>u&&(u=w,g=T)}const y=new THREE.Quaternion().setFromUnitVectors(g,a);h.mesh.quaternion.slerp(y.multiply(h.mesh.quaternion),.1),h.angularVelocity.multiplyScalar(.9)}f+=h.velocity.lengthSq()+h.angularVelocity.lengthSq()}f<W?this.settledFrames++:this.settledFrames=0,this.settledFrames>30&&this.endPhysicsRoll()}forceEndRoll(){if(!this.physicsActive)return;console.warn("Dice roll took too long, forcing it to end."),this.threeDice.filter(t=>!t.data.isHeld||this.isIntroRoll).forEach(t=>{const i=t.getUpValue();t.setValue(i),t.mesh.position.y=.5,t.velocity.set(0,0,0),t.angularVelocity.set(0,0,0)}),this.endPhysicsRoll()}endPhysicsRoll(){if(this.rollTimeout&&(window.clearTimeout(this.rollTimeout),this.rollTimeout=null),!this.physicsActive)return;this.physicsActive=!1,this.settledFrames=0;const e=this.gsm.state.dice.map(t=>{const i=this.threeDice[t.id];return t.isHeld&&!this.isIntroRoll?t.value:(i.velocity.set(0,0,0),i.angularVelocity.set(0,0,0),i.getUpValue())});if(this.isIntroRoll)this.isIntroRoll=!1,this.gsm.state.dice=this.gsm.state.dice.map((t,i)=>({...t,value:e[i],isHeld:!1,isScoring:!1})),this.updateUI();else{const{isFarkle:t}=this.gsm.endRoll(e);this.updateUI(),t?(this.ui.showFarkleMessage(),this.triggerBanter(this.gsm.state.currentPlayer==="human"?"playerFarkle":"aiFarkle"),this.setTimer("farkle",60,()=>{this.ui.hideFarkleMessage(),this.addToLog(`${this.gsm.state.currentPlayer==="human"?"You":"AI"} Farkled!`),this.gsm.farkle(),this.resetDicePositions(),this.runGameLoop(),this.updateUI()})):this.runGameLoop()}}performRoll(e){if(this.gsm.state.isRolling||this.physicsActive)return;this.setHotDiceEffect(!1),this.gsm.startRoll(this.gsm.state.dice),this.physicsActive=!0,this.settledFrames=0;const t=e==="ai",i=t?-3.5:3.5,s=t?4:-4;this.threeDice.filter(n=>!n.data.isHeld).forEach(n=>{n.mesh.position.set((Math.random()-.5)*4,2+Math.random()*2,i+(Math.random()-.5)),n.velocity.set((Math.random()-.5)*3,-Math.random()*2,s+(Math.random()-.5)*2),n.angularVelocity.set((Math.random()-.5)*20,(Math.random()-.5)*20,(Math.random()-.5)*20);const o=new THREE.Vector3(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize(),l=Math.random()*Math.PI*2;n.mesh.quaternion.setFromAxisAngle(o,l)}),this.rollTimeout&&window.clearTimeout(this.rollTimeout),this.rollTimeout=window.setTimeout(()=>this.forceEndRoll(),1e4)}performIntroRoll(){this.isIntroRoll=!0,this.physicsActive=!0,this.settledFrames=0,this.gsm.state.dice.forEach(e=>this.threeDice[e.id].updateData(e)),this.threeDice.forEach((e,t)=>{e.mesh.visible=!0,e.mesh.position.set(this.threeCamera.left-2-t*.2,1.5+Math.random(),(Math.random()-.5)*4),e.velocity.set(9+Math.random()*2,0,(Math.random()-.5)*2),e.angularVelocity.set((Math.random()-.5)*20,(Math.random()-.5)*20,(Math.random()-.5)*20);const i=new THREE.Vector3(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize(),s=Math.random()*Math.PI*2;e.mesh.quaternion.setFromAxisAngle(i,s)}),this.rollTimeout&&window.clearTimeout(this.rollTimeout),this.rollTimeout=window.setTimeout(()=>this.forceEndRoll(),1e4)}handleRoll(){if(this.ui.rollButton.interactive)if(this.gsm.state.phase===d.ROLLED){const{isHotDice:e}=this.gsm.commitSelection();e?(this.addToLog("Hot Dice! You get to roll again."),this.setHotDiceEffect(!0),this.triggerBanter("playerHotDice"),this.updateUI(),this.setTimer("hotDiceRollDelay",120,()=>{this.runGameLoop()})):(this.updateUI(),this.runGameLoop())}else this.gsm.state.phase===d.START_TURN&&(this.performRoll("human"),this.updateUI())}handleBank(){if(!this.ui.bankButton.interactive)return;const e=this.gsm.state.turnScore+this.gsm.state.roundScore;this.addToLog(`You banked ${e} points.`),this.triggerBanter("playerBank",e);const{winner:t}=this.gsm.bankScore(),i=this.gsm.state.players.human.score;i>=R*.8&&i<R&&this.triggerBanter("playerIsWinning"),this.resetDicePositions(),t?this.endGame(t):this.runGameLoop(),this.updateUI()}onCanvasClick(e){if(this.appPhase!==1||this.gsm.state.currentPlayer!=="human"||this.gsm.state.phase!==d.ROLLED)return;const t=this.pixiApp.view.getBoundingClientRect();this.pointer.x=(e.clientX-t.left)/t.width*2-1,this.pointer.y=-((e.clientY-t.top)/t.height)*2+1,this.threeRaycaster.setFromCamera(this.pointer,this.threeCamera);const i=this.threeRaycaster.intersectObjects(this.threeDice.map(s=>s.mesh));if(i.length>0){const s=i[0].object.userData.id,n=this.gsm.state.dice.filter(c=>!c.isHeld),l=M(n).find(c=>c.includes(s));l&&(this.gsm.toggleScoringGroup(l),this.updateUI())}}handleKeyPress(e){e.key==="Escape"&&(document.fullscreenElement?document.exitFullscreen():this.appPhase===1?this.pauseGame():this.appPhase===2?this.resumeGame():this.appPhase===3&&this.hideHowToPlay())}startGame(){this.appPhase=1,this.ui.showGame(),this.gsm.restart(),this.log=[],this.physicsActive=!1,this.settledFrames=0,this.timers={},this.timerCallbacks={},this.opponent.show(),this.resize(this.initialWidth,this.initialHeight),this.performIntroRoll(),this.triggerBanter("gameStart")}pauseGame(){this.appPhase=2,this.ui.showPauseMenu()}resumeGame(){this.appPhase=1,this.ui.hidePauseMenu()}quitToMenu(){this.appPhase=0,this.ui.showMainMenu(),this.threeDice.forEach(e=>{e.mesh.visible=!1,e.highlightCircle.visible=!1}),this.opponent.hide()}showHowToPlay(){this.appPhase=3,this.ui.hidePauseMenu(),this.ui.showHowToPlay()}hideHowToPlay(){this.appPhase=2,this.ui.hideHowToPlay(),this.ui.showPauseMenu()}resetDicePositions(){this.threeDice.forEach(e=>{const t=(e.data.id-2.5)*1.5;e.mesh.position.set(t,.5,0),e.highlightCircle.position.set(t,.01,0),e.setValue(e.data.value)})}endGame(e){this.gsm.state.phase=d.GAME_OVER,this.appPhase=2,this.updateUI();const{playAgainButton:t,quitButton:i}=this.ui.showWinner(e);t.on("pointerdown",()=>this.startGame()),i.on("pointerdown",()=>this.quitToMenu())}runGameLoop(){if(!(this.gsm.state.phase===d.GAME_OVER||this.appPhase!==1)){if(this.gsm.state.phase===d.HUMAN_REROLL){this.performRoll("human"),this.updateUI();return}if(!(this.gsm.state.currentPlayer!=="ai"||this.gsm.state.isRolling))switch(this.gsm.state.phase){case d.START_TURN:this.addToLog("AI is thinking..."),this.setTimer("ai_roll",60,()=>{this.performRoll("ai"),this.updateUI()});break;case d.AI_REROLL:this.setTimer("ai_reroll",60,()=>{this.performRoll("ai"),this.updateUI()});break;case d.ROLLED:this.setTimer("ai_think",60,()=>{this.gsm.aiThink(),this.runGameLoop()});break;case d.AI_THINKING:this.setTimer("ai_select",60,()=>{this.aiSelectDiceLogic(),this.updateUI(),this.runGameLoop()});break;case d.AI_DECIDING:this.setTimer("ai_decide",90,()=>this.aiDecideLogic());break}}}aiSelectDiceLogic(){const e=this.gsm.state.dice.filter(s=>!s.isHeld),i=M(e).flat();this.gsm.aiSelectDice(i)}async aiDecideLogic(){const{turnScore:e,roundScore:t,players:i}=this.gsm.state,s=e+t,n=i.ai.score,o=i.human.score;if(n+s>=R){this.addToLog(`AI banked ${s} to win!`),await this.triggerBanter("aiBank",s);const{winner:a}=this.gsm.bankScore();this.resetDicePositions(),a&&this.endGame(a);return}const c=6-this.gsm.state.dice.filter(a=>a.isHeld||a.isScoring).length;if(c===0){this.addToLog("AI has Hot Dice! Rolling again..."),this.gsm.commitSelection(),this.setHotDiceEffect(!0),this.updateUI(),await this.triggerBanter("aiHotDice"),this.runGameLoop();return}let f=1;const m=o-n;m>400&&(f=1.3),m<-400&&(f=.7),o>=R*.8&&(f=1.5);let S=300;c>=4&&(S=400),c<=2&&(S=250),c===1&&(S=200);const x=S*f;if(s<x)this.addToLog(`AI is rolling again with ${c} dice.`),this.gsm.commitSelection(),this.runGameLoop();else{this.addToLog(`AI banked ${s} points.`),await this.triggerBanter("aiBank",s);const{winner:a}=this.gsm.bankScore(),u=this.gsm.state.players.ai.score;u>=R*.8&&u<R&&await this.triggerBanter("aiIsWinning"),this.resetDicePositions(),a?this.endGame(a):this.runGameLoop()}this.updateUI()}async triggerBanter(e,t){const i=B[e]||B.idle,s=i[Math.floor(Math.random()*i.length)];s&&await this.opponent.showBanter(s)}addToLog(e){this.log=[e,...this.log.slice(0,4)]}updateUI(){this.gsm.state.dice.forEach(e=>{const t=this.threeDice.find(i=>i.data.id===e.id);t&&t.updateData(e)}),this.ui.update(this.gsm.state)}setHotDiceEffect(e){this.isHotDiceActive=e,this.threeDice.forEach(t=>t.setHot(e))}toggleFullscreen(){const e=document.getElementById("game-wrapper");e&&(document.fullscreenElement?document.exitFullscreen():e.requestFullscreen())}onFullscreenChange(){const e=document.getElementById("fullscreen-btn"),t=e==null?void 0:e.querySelector(".fullscreen-icon"),i=e==null?void 0:e.querySelector(".exit-fullscreen-icon");document.fullscreenElement?(this.resize(window.innerWidth,window.innerHeight),t&&i&&(t.style.display="none",i.style.display="block")):(this.resize(this.initialWidth,this.initialHeight),t&&i&&(t.style.display="block",i.style.display="none"))}resize(e,t){this.pixiApp.renderer.resize(e,t),this.threeRenderer.setSize(e,t);const i=e/t;this.threeCamera.left=this.frustumSize*i/-2,this.threeCamera.right=this.frustumSize*i/2,this.threeCamera.top=this.frustumSize/2,this.threeCamera.bottom=this.frustumSize/-2,this.threeCamera.updateProjectionMatrix(),this.threePlane&&(this.threePlane.geometry.dispose(),this.threePlane.geometry=new THREE.PlaneGeometry(this.frustumSize*i,this.frustumSize)),this.ui&&this.ui.resize(e,t),this.opponent&&this.opponent.resize(e,t)}}const A=document.getElementById("game-container");if(A){const r=new Y(A);r.load().then(()=>{r.start()})}else console.error("Game container not found!");document.addEventListener("DOMContentLoaded",()=>{const r=document.getElementById("mobile-menu-button"),e=document.getElementById("mobile-menu"),t=document.getElementById("menu-icon-open"),i=document.getElementById("menu-icon-close");r&&e&&t&&i&&r.addEventListener("click",()=>{const s=r.getAttribute("aria-expanded")==="true";r.setAttribute("aria-expanded",!s),e.classList.toggle("hidden"),t.classList.toggle("hidden"),i.classList.toggle("hidden")})});
